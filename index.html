<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Generator Kode Unik WAC NasDem</title>
<style>
body { font-family:sans-serif; display:flex; justify-content:center; margin-top:50px; }
.container { width:350px; padding:20px; border-radius:12px; box-shadow:0 4px 10px rgba(0,0,0,0.2); }
input, select, button { width:100%; padding:8px; margin:6px 0; border-radius:8px; }
.result { margin-top:10px; padding:10px; border:1px dashed #f5b700; display:none; }
</style>
</head>
<body>
<div class="container">
  <h3>Generator Kode Unik</h3>
  <input type="text" id="nama" placeholder="Nama Kepala">
  <select id="kecamatan"><option>Pilih Kecamatan...</option></select>
  <select id="kelurahan"><option>Pilih Kelurahan...</option></select>
  <button id="generateBtn">Generate Kode</button>
  <div class="result" id="result"></div>
</div>

<script>
const scriptURL = "https://script.google.com/macros/s/AKfycbxxxxxxxxxxxxxxxxxxxx/exec"; // ganti ini

let wilayahData = [];

// Load Wilayah dari Apps Script
async function loadWilayah(){
  try{
    const res = await fetch(scriptURL+"?action=getWilayah");
    const data = await res.json();
    if(data.success){
      wilayahData = data.data || [];
      const kecSelect = document.getElementById("kecamatan");
      kecSelect.innerHTML = '<option value="">Pilih Kecamatan...</option>';
      [...new Set(wilayahData.map(w=>w.kecamatan))].forEach(k=>{
        kecSelect.innerHTML += `<option value="${k}">${k}</option>`;
      });
    }else{ alert(data.message); }
  }catch(e){ alert("Gagal memuat data wilayah."); console.error(e);}
}

// Update dropdown Kelurahan
document.getElementById("kecamatan").addEventListener("change", (e)=>{
  const kelSelect = document.getElementById("kelurahan");
  kelSelect.innerHTML = '<option value="">Pilih Kelurahan...</option>';
  const selected = e.target.value;
  wilayahData.filter(w=>w.kecamatan===selected).forEach(w=>{
    kelSelect.innerHTML += `<option value="${w.kelurahan}">${w.kelurahan}</option>`;
  });
});

// Generate Kode
document.getElementById("generateBtn").addEventListener("click", async ()=>{
  const nama = document.getElementById("nama").value.trim();
  const kec = document.getElementById("kecamatan").value.trim();
  const kel = document.getElementById("kelurahan").value.trim();
  const resultDiv = document.getElementById("result");
  if(!nama||!kec||!kel){ alert("Isi semua kolom!"); return; }
  resultDiv.style.display="block";
  resultDiv.innerText="Menghasilkan kode...";
  try{
    const res = await fetch(scriptURL,{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({nama, kecamatan:kec, kelurahan:kel})
    });
    const data = await res.json();
    if(data.success){
      resultDiv.innerHTML = (data.reused ? "Kode lama kamu:" : "Kode baru kamu:") +
        `<br><strong style="color:#f5b700">${data.token}</strong>`;
    }else resultDiv.innerText = data.message;
  }catch(err){ console.error(err); resultDiv.innerText="Terjadi kesalahan.";}
});

loadWilayah();
</script>
</body>
</html>
