<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Generator Kode Kepala Wilayah</title>
<style>
body { font-family: 'Segoe UI', sans-serif; background:#f7f9fb; display:flex; justify-content:center; align-items:center; min-height:100vh; margin:0;}
.container { background:white; border-radius:16px; padding:24px; box-shadow:0 4px 12px rgba(0,0,0,0.1); width:100%; max-width:420px;}
h2{text-align:center;color:#222;}
label{display:block;margin-top:12px;font-weight:600;}
input, select, button{width:100%;padding:10px;margin-top:4px;border:1px solid #ccc;border-radius:8px;font-size:15px;box-sizing:border-box;}
button{background:#0078ff;color:white;font-weight:600;cursor:pointer;transition:.3s;margin-top:20px;}
button:hover{background:#005fc7;}
.result{margin-top:20px;text-align:center;padding:12px;background:#e8f5e9;border-radius:8px;font-weight:600;color:#2e7d32;display:none;word-break:break-all;}
.error{background:#ffebee;color:#c62828;}
</style>
</head>
<body>
<div class="container">
<h2>Generate Kode Kepala</h2>
<label>Nama Lengkap</label>
<input type="text" id="nama" placeholder="Masukkan nama lengkap">

<label>Kecamatan</label>
<select id="kecamatan"></select>

<label>Kelurahan</label>
<select id="kelurahan"></select>

<button id="generateBtn">Generate</button>
<div class="result" id="result"></div>
</div>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzUVf20jkmegdOc4JbsD8kHpbQ-5UVtZqiZx75B392Ck3tdob30EF2DcnvGQjxexk5w2g/exec"; // ganti URL Web App GAS

let wilayahData = [];

async function loadWilayah() {
    try {
        const res = await fetch(`${SCRIPT_URL}?action=getWilayah`);
        const data = await res.json();
        wilayahData = data.data || [];

        const kecSelect = document.getElementById("kecamatan");
        kecSelect.innerHTML = '<option value="">Pilih Kecamatan</option>';
        [...new Set(wilayahData.map(w=>w.kecamatan))].forEach(k=>{
            kecSelect.innerHTML += `<option value="${k}">${k}</option>`;
        });
    } catch(err) {
        alert("Gagal memuat data wilayah. Periksa koneksi atau izin Apps Script.");
    }
}

document.getElementById("kecamatan").addEventListener("change", e=>{
    const selected = e.target.value;
    const kelSelect = document.getElementById("kelurahan");
    kelSelect.innerHTML = '<option value="">Pilih Kelurahan</option>';
    wilayahData.filter(w=>w.kecamatan===selected).forEach(w=>{
        kelSelect.innerHTML += `<option value="${w.kelurahan}">${w.kelurahan}</option>`;
    });
});

document.getElementById("generateBtn").addEventListener("click", async ()=>{
    const nama = document.getElementById("nama").value.trim();
    const kelurahan = document.getElementById("kelurahan").value.trim();
    const kecamatan = document.getElementById("kecamatan").value.trim();
    const resultDiv = document.getElementById("result");

    if(!nama || !kelurahan || !kecamatan){
        resultDiv.textContent = "Isi semua kolom!";
        resultDiv.classList.add("error");
        resultDiv.style.display="block";
        return;
    }

    resultDiv.style.display="block";
    resultDiv.classList.remove("error");
    resultDiv.textContent="Menghasilkan kode...";

    try {
        const res = await fetch(`${SCRIPT_URL}?action=generate&nama=${encodeURIComponent(nama)}&kelurahan=${encodeURIComponent(kelurahan)}&kecamatan=${encodeURIComponent(kecamatan)}`);
        const data = await res.json();

        if(data.status==="success"){
            resultDiv.textContent = "✅ Kode unik baru: " + data.kode;
            resultDiv.classList.remove("error");
        } else if(data.status==="exists"){
            resultDiv.textContent = "⚠️ Kode sudah ada: " + data.kode;
            resultDiv.classList.remove("error");
        } else {
            resultDiv.textContent = "❌ " + data.message;
            resultDiv.classList.add("error");
        }
    } catch(err){
        resultDiv.textContent = "❌ Gagal terhubung ke server: " + err.message;
        resultDiv.classList.add("error");
    }
});

loadWilayah();
</script>
</body>
</html>
