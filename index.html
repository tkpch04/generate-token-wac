<script>
    // *** GANTI DENGAN URL WEB APP ANDA YANG TERAKHIR ***
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzUVf20jkmegdOc4JbsD8kHpbQ-5UVtZqiZx75B392Ck3tdob30EF2DcnvGQjxexk5w2g/exec"; 

    document.getElementById("generateForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        
        const submitButton = document.getElementById("submitButton");
        const resultDiv = document.getElementById("result");
        const nama = document.getElementById("nama").value.trim();
        const kelurahan = document.getElementById("kelurahan").value.trim();
        const kecamatan = document.getElementById("kecamatan").value.trim();

        if (!nama || !kelurahan) {
            // ... (Validasi tetap sama) ...
            return;
        }

        // --- SOLUSI CORS: Mengubah Data ke URL Parameters ---
        const urlParams = new URLSearchParams({
            action: "generateToken", // PENTING: Untuk memicu logika di doGet
            nama: nama,
            kelurahan: kelurahan,
            kecamatan: kecamatan
        });
        
        const targetUrl = `${SCRIPT_URL}?${urlParams.toString()}`;

        // Status loading
        submitButton.disabled = true;
        submitButton.textContent = "Memproses...";
        resultDiv.style.display = "block";
        resultDiv.textContent = "Mengirim data via GET...";
        resultDiv.classList.remove("error");

        try {
            const res = await fetch(targetUrl, {
                method: "GET", // *** UBAH KE GET ***
                // Hapus headers dan body. Request kini Sederhana.
            });

            // Cek status HTTP, jika OK, lanjut baca JSON
            if (!res.ok) {
                throw new Error(`Server merespon status HTTP ${res.status}`);
            }

            const data = await res.json();
            // ... (Logika penanganan success/exists/error tetap sama) ...
            let finalMessage = "";

            if (data.status === "success") {
                finalMessage = `✅ **Kode berhasil dibuat:** ${data.kode}`;
                resultDiv.classList.remove("error");
                resultDiv.style.backgroundColor = '#e8f5e9';
                resultDiv.style.color = '#2e7d32';
            } else if (data.status === "exists") {
                finalMessage = `⚠️ **Kode sudah ada:** ${data.kode} (Data ini telah terdaftar)`;
                resultDiv.classList.remove("error");
                resultDiv.style.backgroundColor = '#fff3e0';
                resultDiv.style.color = '#ff6f00';
            } 
            else { // status === "error"
                finalMessage = `❌ **Gagal:** ${data.message || "Terjadi kesalahan yang tidak diketahui."}`;
                resultDiv.classList.add("error");
            }

            resultDiv.innerHTML = finalMessage;
            resultDiv.style.display = "block";


        } catch (err) {
            // Tangani kesalahan jaringan
            resultDiv.textContent = `❌ Gagal terhubung/membaca respons server: ${err.message}. Mohon cek URL dan koneksi.`;
            resultDiv.classList.add("error");
        } finally {
            submitButton.disabled = false;
            submitButton.textContent = "Generate";
        }
    });
</script>
